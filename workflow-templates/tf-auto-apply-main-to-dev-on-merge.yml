name: Auto Apply main branch to Dev on PR Merge
on: 
  pull_request:
    types: [closed]

env:
  PAGERDUTY_SERVICE_IDS: '[ "P0XXXXX", "ADD_YOUR_SERVICE_ID(S)" ]'  # TODO:  Add your PD Service IDs here
  PAGERDUTY_WINDOW_IN_MIN: 10                                       # TODO:  Verify the length of your PD Maintenance Window
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_ENVIRONMENT: 'public'
  TF_IN_AUTOMATION: 'true'
  SSH_KEY_CENTRAL_LOGGING: ${{secrets.SSH_CENTRAL_LOGGING}}
  SSH_KEY_STORAGE_ACCOUNT: ${{secrets.SSH_STORAGE_ACCOUNT}}
  SSH_KEY_ON_PREM_EGRESS: ${{secrets.SSH_ON_PREM_EGRESS}}

jobs:
  auto-apply-tf:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    
    runs-on: [self-hosted, ubuntu-20.04]

    environment: 'Dev'
    
    defaults:
      run:
        shell: bash
        working-directory: ./dev # TODO:  Verify this is correct for your repository

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup SSH Keys and known_hosts
        uses: im-open/setup-deploy-keys@1.0.1
        with:
          deploy-key-info: |
            [
              { "orgAndRepo": "im-platform/central-logging", "envName" : "SSH_KEY_CENTRAL_LOGGING" },
              { "orgAndRepo": "im-platform/storage-account-network-rules", "envName" : "SSH_KEY_STORAGE_ACCOUNT" },
              { "orgAndRepo": "im-platform/on-prem-egress-ips", "envName" : "SSH_KEY_ON_PREM_EGRESS" }
            ]

      - name: Setup Terraform
        id: setup
        uses: hashicorp/setup-terraform@v1.2.1
        with:
          terraform_version: ~>0.15.5 # TODO:  Verify the tf version
      
      - name: Terraform Init
        id: init
        run: terraform init
      
      - name: Open a PagerDuty Maintenance Window
        id: open-window
        uses: im-open/open-pagerduty-maintenance-window@v1.0.0
        with:
          pagerduty-api-key: ${{secrets.PAGERDUTY_API_KEY}}
          description: 'Auto apply main branch to Dev environment from GitHub Actions' # TODO:  Verify this description
          minutes: ${{ env.PAGERDUTY_WINDOW_IN_MIN }}
          service-ids: '[ "P0XXXXX" ]'

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve \
            -var="pagerduty_token=${{secrets.PAGERDUTY_TOKEN}}"

      - name: Close the PagerDuty Maintenance Window
        uses: im-open/close-pagerduty-maintenance-window@v1.0.0
        with:
          pagerduty-api-key: ${{secrets.PAGERDUTY_API_KEY}}
          maintenance-window-id: ${{ steps.open-window.outputs.maintenance-window-id }}        