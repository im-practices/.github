# Workflow Code: FierceRabbit_v1    DO NOT REMOVE
# Purpose:
#    Creates an ad hoc PagerDuty event annotation for a specified
#    service when someone kicks it off manually.
#
# Frequency:
#    - This workflow should only be used once per repository assuming
#      there is only one app insights instance set up per env
#
# Projects to use this Template with:
#    - Azure App Service or Function (Optional Template)
#    - Azure SQL Database            (Optional Template)
#    - Terraform                     (Optional Template)
#
# TODO: Prerequisites:
#    - Ensure each of the repo-level and env-level secrets used in this workflow have been populated by an admin in your repository.
#    - Add a pagerduty integration key to your env-level secrets. This integration key can be generated by your terraform.

name: Runbook - Annotate PagerDuty
run-name: Annotate ${{ inputs.event }} in ${{ inputs.environment }} PagerDuty
on:
  workflow_dispatch:
    inputs:
      environment:
        description: The environment the service is in
        required: true
        default: prod
        type: choice
        options: # TODO: Update for the environments that are available
          - dev
          - qa
          - stage
          - demo
          - uat
          - prod
        
      event:
        description: The event description to record
        required: true

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}

jobs:
  create-annotation:
    runs-on: [self-hosted, im-linux]
    environment: ${{ github.event.inputs.environment }}
    steps:
      - run: |
          echo $'
          | Build Arguments | Value                                      |
          | ---             |  ---                                       |
          | Environment     | `${{ env.ENVIRONMENT }}`                   |
          | Event           | `${{ github.event.inputs.event }}`         |' >> $GITHUB_STEP_SUMMARY
              

      - name: Create a change event
        uses: im-open/pagerduty-change-events-action@v5
        with:
          integration-key: ${{ secrets.PAGERDUTY_EVENT_INTEGRATION_KEY }}
          custom-event: ${{ github.event.inputs.event }}
