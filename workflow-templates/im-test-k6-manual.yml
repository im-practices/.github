# Workflow Code: ZestyFlamingo_v9    DO NOT REMOVE
# Purpose:
#    Uses a container to run a K6 stress test against the environment and
#    with the test file the user specifies when they kick it off manually.
#
# Frequency:
#    - This workflow is intended to be reusable, and used once per repository.
#      If the workflow is updated to hardcode some arguments like test-file
#      and test-root-folder instead of taking them in as args, then it could
#      be duplicated, once per k6 project in the repo.
#
# Projects to use this Template with:
#    - App Service or Function (Optional Template)
#    - On-Prem Service         (Optional Template)

name: Run K6 test

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment to run test against'
        required: true
        default: 'dev'
        type: choice
        options: # TODO:  Update for the environments your k6 test can be run against
          - dev
          - qa
          - stage
          - load
      working-directory:
        description: 'Root directory of k6 test files including configs, etc. IE: tests/k6'
        required: true
        default: '' # TODO: Add the location of your tests.  IE: tests/k6
      test-file:
        description: 'K6 test file to run'
        required: true
        default: '' # TODO: Add default test file  IE: check-health-simple.js
      run-name: # Run name is used to separate load test runs from each other.
        description: "Run Name: Name of k6 test run in logs and kubernetes."
        required: true
        default: "Test-Check-Health" # TODO: Update Default k6 run name.  
      k6-paramaters:
        description: 'K6 extra paramaters. IE: -tag product=TEST,family=TEST'
        required: false
      k6-version:
        description: 'K6 version.  Versions lower than 0.32.0 will not work with this action.  Do not include the "v" prefix.'
        required: true
        default: '0.38.3' # TODO: Set default version of k6. IE. 0.33.0
      number-of-runners:
        description: 'Number of Runners: specify number of github self hosted runners.  Max: 10 or maxiumum self hosted linux runners.'
        required: true
        default: '1'
      run-npm-build: # TODO: Delete input if you don't build your k6 tests with npm
        description: "Run NPM Build: Run npm build to create packages k6 tests"
        required: false
        type: boolean
        default: false # TODO: Set true if you require npm build to run for your k6 bundle to be created

env:
  NODE_VERSION: '16.x' # TODO: Set correct node version or delete if not use npm to build tests
  K6_DEFAULT_PARAMATERS: '--out influxdb=http://10.206.225.188:8086/loadtesting --insecure-skip-tls-verify --tag NAME=${{ github.event.inputs.run-name }},test=${{ github.event.inputs.test-file }} -e RUN_ENV=${{ github.event.inputs.env }}' # TODO: Set default k6 paramaters

jobs:
  matrix-setup:
    runs-on: ubuntu-20.04

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Set Runner Matrix
        id: set-matrix
        uses: actions/github-script@v6
        with:
          script: |
            let matrix = [];
            if(${{ github.event.inputs.number-of-runners }} > 10){
              matrix = ["runner-1"];
              core.setCommandEcho("You selected too many runners.  Please select under 10.");
              core.warning("You selected too many runners.  Please select under 10.");
            }else{
              for (i=1; i<= ${{ github.event.inputs.number-of-runners }}; i++){
                matrix.push(`runner-${i}`);
              }
            }
            const matrixObject = { "runners": matrix };
            core.setCommandEcho("Matrix set: " + JSON.stringify(matrixObject));
            core.setOutput('matrix',JSON.stringify(matrixObject));

      - name: Annotate Test Paramaters
        uses: actions/github-script@v6
        with:
          script: |
            var output = `
              Workflow Inputs =>
                Environment: ${{ github.event.inputs.env }};
                Test File: ${{ github.event.inputs.test-file }};
                Run Name: ${{ github.event.inputs.run-name }};
                K6 Version: ${{ github.event.inputs.k6-version }};
                Number of Runners: ${{ github.event.inputs.number-of-runners }};
                Run NPM Build: ${{ github.event.inputs.run-npm-build }};
                K6 Paramaters: ${{ github.event.inputs.k6-paramaters }};
                K6 Default Paramaters: ${{ env.K6_DEFAULT_PARAMATERS }};
            `;
            core.notice(`${output}`);

  k6_test:
    runs-on: [self-hosted, ubuntu-20.04]
    needs: [matrix-setup]

    defaults:
      run:
        shell: bash

    strategy:
      matrix: ${{ fromJson(needs.matrix-setup.outputs.matrix) }}

    steps:
      - run: echo "The current environment is ${{ github.event.inputs.env }}"

      - run: echo "${{ needs.matrix-setup.outputs.matrix }}"
      - name: Checkout
        uses: actions/checkout@v1

      # TODO: Delete if you don't build your k6 tests
      - name: Install Node ${{ env.NODE_VERSION }}
        if: github.event.inputs.run-npm-build == 'true'
        uses: actions/setup-node@v2
        with:
            node-version: ${{ env.NODE_VERSION }}

      # TODO: Delete if you don't build your k6 tests
      - name: NPM Cache
        id: npm-cache
        if: github.event.inputs.run-npm-build == 'true'
        uses: actions/cache@v2
        with:
          path: '${{ github.event.inputs.working-directory }}/node_modules'
          key: ${{ runner.os }}-modules-k6-${{ hashFiles('${{ github.event.inputs.working-directory }}/package-lock.json') }}
          restore-keys: ${{ runner.os }}-modules-k6-

      # TODO: Delete if you don't build your k6 tests
      - name: Install NPM Dependencies
        if: github.event.inputs.run-npm-build == 'true' && steps.npm-cache.outputs.cache-hit != 'true'
        run: npm install
        working-directory: ${{ github.event.inputs.working-directory }}

      # TODO: Delete if you don't build your k6 tests
      - name: Build K6 Tests via npm build
        if: github.event.inputs.run-npm-build == 'true'
        run: npm run build
        working-directory: ${{ github.event.inputs.working-directory }}

      - name: Install K6 Client
        uses: im-open/setup-k6-perf-testing@v1.0.1
        with:
          version: ${{ github.event.inputs.k6-version }}

      - name: Validate test file exists
        run: |
          echo "Checking if test file exists:"
          FILE="./${{ github.event.inputs.working-directory }}/${{ github.event.inputs.test-file }}"
          if [[ -f $FILE ]]; then
            echo "$FILE exists."
          else
            echo "Could not find test file. $FILE"
            exit 1
          fi

      - name: Run local k6 test
        working-directory: ${{ github.event.inputs.working-directory }}
        run: |
          k6_args="${{ github.event.inputs.k6-paramaters }}"

          k6_test_file_tag="--tag test=${{ github.event.inputs.test-file }}"
          # Removing slashes from k6_test_file_tag
          k6_test_file_tag=$(echo $k6_test_file_tag  | tr '/' '-')

          k6_params=""
          if [[ -z k6_args ]]; then
            k6_params="${{ env.K6_DEFAULT_PARAMATERS }} $k6_test_file_tag"
          else
            k6_params="${{ env.K6_DEFAULT_PARAMATERS }} $k6_args $k6_test_file_tag"
          fi

          echo "K6 Parmaters passing in:"
          echo $k6_params
          echo "::notice file=k6.params,line=1,col=1,endColumn=1::$k6_params"

          # Running the test
          k6 run ${{ github.event.inputs.test-file }} $k6_params
